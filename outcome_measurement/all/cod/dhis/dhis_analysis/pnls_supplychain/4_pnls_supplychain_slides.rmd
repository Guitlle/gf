---
title: "PNLS Supply Chain Analysis"
author: "IHME PCE"
date: "May 21, 2019"
output: beamer_presentation
---

```{r setup, include=FALSE, echo=FALSE}
# -----------------------------------------------
# Set up R
#------------------------------------------------
library(data.table)
library(raster)
library(ggplot2)
library(tibble)
library(dplyr)
library(RColorBrewer)
library(rgdal)
library(rgeos)
library(maptools)
#Source your prep code
repo_root = "C:/Users/elineb/Documents/gf/" #Set to the root of your repository 
setwd(repo_root)
source('./core/standardizeDPSNames.R')

j = ifelse(Sys.info()[1]=='Windows', 'J:', '/home/j')
dir = paste0(j,  '/Project/Evaluation/GF/outcome_measurement/cod/dhis_data/prepped/') #Home directory
saveDir = paste0(j, 'Project/Evaluation/GF/outcome_measurement/cod/dhis_data/outputs/pnls/')
codeDir = paste0(repo_root, "outcome_measurement/all/cod/dhis/dhis_analysis/pnls_supplychain/")

#Source the prep code 
preppedDT = readRDS(paste0(dir, 'pnls_drug.rds'))
dt = copy(preppedDT)

#Read in the shapefile
shapefile = shapefile("J:/Project/Evaluation/GF/mapping/cod/gadm36_COD_shp/gadm36_COD_1.shp")
shapefile@data$NAME_1 = standardizeDPSNames(shapefile@data$NAME_1)

# use the fortify function to convert from spatialpolygonsdataframe to data.frame
coord = data.table(fortify(shapefile)) 
coord[, id:=as.numeric(id)]
coord_ann = rbind(coord, coord)
coord_ann[, year:=rep(2017:2018, each=nrow(coord))] #What years do you have data for? 

#Make a coordinate map for the months you have available in the data. 
dates_avail = unique(dt[, .(date)][order(date)])
coord_months = data.table()
for (i in dates_avail){
  print(i)
  temp = coord
  temp[, date:=i]
  coord_months = rbind(coord_months, temp)
}

# Add in a clustered level variable to make scatter plots with later. THIS NEEDS TO BE VERIFIED. 
# CHANGE LEVEL 2 TO A STRING NAME. 
dt[ level%in%c('health_post', 'dispensary'), level2:=2]
dt[ level%in%c('health_center', 'reference_health_center', 'medical_center', 'clinic', 'polyclinic'), level2:=3]
dt[ level%in%c('general_reference_hospital', 'hospital_center', 'hospital', 'secondary_hospital', 'medical_surgical_center'), level2:=4]

#sUBSET TO ONE WITH ALL 12, AND THEN MAKE LEVEL 2 TO HEALTH POST, HEALTH CENTER, HOSPITAL, AND OTHER. 

# ------------------------------------------------------
# Prep some color palettes
#-------------------------------------------------------

two = c('#91bfdb', '#bd0026')
ratio_colors = brewer.pal(8, 'Spectral')
results_colors = brewer.pal(6, 'Blues')
sup_colors = brewer.pal(6, 'Reds')
ladies = brewer.pal(11, 'RdYlBu')
gents = brewer.pal(9, 'Purples')

graph_colors = c('#bd0026', '#fecc5c', '#74c476','#3182bd', '#8856a7')
tri_sex = c('#bd0026', '#74c476', '#3182bd')
wrap_colors = c('#3182bd', '#fecc5c', '#bd0026', '#74c476', '#8856a7', '#f768a1')
sex_colors = c('#bd0026', '#3182bd', '#74c476', '#8856a7') # colors by sex plus one for facilities
single_red = '#bd0026'

colScale = scale_fill_gradient2(low="red", high="green", midpoint=0)
colScale2 = scale_fill_gradient2(low="green", high="red", midpoint=0)

#Make a graph of key elements and their names in the data, so it's easy to source below. 
drugs = data.table(call=c("DETERMINE", "UNIGOLD", "DOUBLECHECK"), 
                   drug_id=c("Gv1UQdMw5wL", "ctP0MNHiq3B", "k3JmmwNHkmY"), 
                   drug_name=c("Determine test kit", "Uni-Gold test kit", "Double-check test kit"))


#ADD SOME DATE RANGES TO SOURCE WITH THE FUNCTIONS BELOW
full_date_range = "Jan 2017 - Dec 2018" #Imported into the graphs automatically - update as you get more data. 
partial_date_range = "Same time period: January - September" #Date range of 'AnnualDT' below - to have comparable time periods. Update as you get more data. 

#Source the graphs 
source(paste0(codeDir, "4_pnls_supplychain_graph_functions.r"))
```

## Reporting Completeness

```{r reporting1, echo=FALSE, warning=FALSE}
# Run for Determine test kits, but could also run for all drugs? 
plot = gen_report1(dt, drugs[call=="DETERMINE", drug_id], drugs[call=="DETERMINE", drug_name], full_date_range)
plot
```

## Reporting Completeness
```{r reporting2, echo=FALSE, warning=FALSE}
plot = gen_report2(dt, drugs[call=="DETERMINE", drug_id], drugs[call=="DETERMINE", drug_name], full_date_range)
plot
```

## Reporting completeness

GRAPH TO GO HERE 

## Stockouts of first-line test kits 
```{r stockout1, echo=FALSE, warning=FALSE}
plot = gen_stockout1(dt, drugs[call=="DETERMINE", drug_id], drugs[call=="DETERMINE", drug_name])
plot
```

## Percentage of facilities stocked out of first-line test kits

```{r stockout1, echo=FALSE, warning=FALSE}
plot = gen_stockout2(dt, drugs[call=="DETERMINE", drug_id], drugs[call=="DETERMINE", drug_name])
plot
```

## Stockouts of first-line test kits, controlled for reporting

GRAPH TO GO HERE 

## Total days stocked out by facility

GRAPH TO GO HERE 

## Map of total facility-days of stockouts

GRAPH TO GO HERE 

## Map of Mean number of days stocked out

GRAPH TO GO HERE 

## Rate of change of stockouts

GRAPH TO GO HERE 

## Stock-out rate of change, by month

GRAPH TO GO HERE 

## Districts with more stockouts in 2018 than 2017

GRAPH TO GO HERE 

## Percentage of facility-days stocked out

GRAPH TO GO HERE 

## Days stocked out by facility level (all)

GRAPH TO GO HERE 

## Days stocked out by facility level (grouped)

GRAPH TO GO HERE 

## Days stocked out by facility level (grouped, by year)

GRAPH TO GO HERE 

## Stock-out duration, 2017 (No stockouts - 2 MO)

GRAPH TO GO HERE 

## Stock-out duration, 2017 (2-month intervals)

GRAPH TO GO HERE 

## Stock-out duration, 2018 (No stockouts - 2 MO)

GRAPH TO GO HERE 

## Stock-out duration, 2018 (2-month intervals)

GRAPH TO GO HERE 

## Mean drug units per facility, by district



