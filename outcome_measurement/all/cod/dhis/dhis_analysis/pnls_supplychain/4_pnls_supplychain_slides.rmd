---
title: "PNLS Supply Chain Analysis"
author: "IHME PCE"
date: "May 21, 2019"
output: beamer_presentation
---

```{r setup, include=FALSE, echo=FALSE}
rm(list=ls())
# -----------------------------------------------
# Set up R
#------------------------------------------------
library(data.table)
library(raster)
library(ggplot2)
library(tibble)
library(dplyr)
library(RColorBrewer)
library(rgdal)
library(rgeos)
library(maptools)
#Source your prep code
repo_root = "C:/Users/elineb/Documents/gf/" #Set to the root of your repository 
setwd(repo_root)
source('./core/standardizeDPSNames.R')

#-----------------------------------------------
#SET THE GLOBAL VARIABLES FOR THIS R MARKDOWN 
#-----------------------------------------------
drug_id = "Gv1UQdMw5wL"
drug_name = "Determine test kit"
full_date_range = "Jan 2017 - Dec 2018" #Imported into the graphs automatically - update as you get more data. 
partial_date_range = "Same time period: January - September" #Date range of 'AnnualDT' below - to have comparable time periods. Update as you get more data. 

#Set up directories 
j = ifelse(Sys.info()[1]=='Windows', 'J:', '/home/j')
dir = paste0(j,  '/Project/Evaluation/GF/outcome_measurement/cod/dhis_data/prepped/') #Home directory
saveDir = paste0(j, 'Project/Evaluation/GF/outcome_measurement/cod/dhis_data/outputs/pnls/')
codeDir = paste0(repo_root, "outcome_measurement/all/cod/dhis/dhis_analysis/pnls_supplychain/")

#Source the prep code 
preppedDT = readRDS(paste0(dir, 'pnls_drug.rds'))
dt = copy(preppedDT)

#Subset the data table to the drug you want.
dt = dt[element_id==drug_id]

#Read in the shapefile
shapefile = shapefile("J:/Project/Evaluation/GF/mapping/cod/gadm36_COD_shp/gadm36_COD_1.shp")
shapefile@data$NAME_1 = standardizeDPSNames(shapefile@data$NAME_1)

# use the fortify function to convert from spatialpolygonsdataframe to data.frame
coord = data.table(fortify(shapefile)) 
coord[, id:=as.numeric(id)]
coord_ann = rbind(coord, coord)
coord_ann[, year:=rep(2017:2018, each=nrow(coord))] #What years do you have data for? 

#Make a coordinate map for the months you have available in the data. 
dates_avail = unique(dt[, .(date)][order(date)])
coord_months = data.table()
for (i in dates_avail){
  print(i)
  temp = coord
  temp[, date:=i]
  coord_months = rbind(coord_months, temp)
}

# Add in a clustered level variable to make scatter plots with later. 
#Just label health post, health center, and hospital, and call everything else 'other'. 
dt[, level2:=level]
dt[!level%in%c('health_post', 'health_center', 'hospital'), level2:='other']

#sUBSET TO ONE WITH ALL 12, AND THEN MAKE LEVEL 2 TO HEALTH POST, HEALTH CENTER, HOSPITAL, AND OTHER. 

# ------------------------------------------------------
# Prep some color palettes
#-------------------------------------------------------

two = c('#91bfdb', '#bd0026')
ratio_colors = brewer.pal(8, 'Spectral')
results_colors = brewer.pal(6, 'Blues')
sup_colors = brewer.pal(6, 'Reds')
ladies = brewer.pal(11, 'RdYlBu')
gents = brewer.pal(9, 'Purples')

graph_colors = c('#bd0026', '#fecc5c', '#74c476','#3182bd', '#8856a7')
tri_sex = c('#bd0026', '#74c476', '#3182bd')
wrap_colors = c('#3182bd', '#fecc5c', '#bd0026', '#74c476', '#8856a7', '#f768a1')
sex_colors = c('#bd0026', '#3182bd', '#74c476', '#8856a7') # colors by sex plus one for facilities
single_red = '#bd0026'

colScale = scale_fill_gradient2(low="red", high="green", midpoint=0)
colScale2 = scale_fill_gradient2(low="green", high="red", midpoint=0)

#Source the graphs 
source(paste0(codeDir, "4_pnls_supplychain_graph_functions.r"))
```

## Reporting Completeness

```{r reporting1, echo=FALSE, warning=FALSE}
# Run for Determine test kits, but could also run for all drugs? 
plot = gen_report1(dt, drug_id, drug_name, full_date_range)
plot
```

## Reporting Completeness
```{r reporting2, echo=FALSE, warning=FALSE}
plot = gen_report2(dt, drug_id, drug_name, full_date_range)
plot
```

## Reporting completeness

```{r reporting3, echo=FALSE, warning=FALSE}
plot = gen_report3(dt, coord_ann, drug_id, drug_name, full_date_range)
plot
```

## Stockouts of first-line test kits 
```{r stockout1, echo=FALSE, warning=FALSE}
plot = gen_stockout1(dt, drug_id, drug_name)
plot
```

## Percentage of facilities stocked out of first-line test kits

```{r stockout2, echo=FALSE, warning=FALSE}
plot = gen_stockout2(dt, drug_id, drug_name)
plot
```

## Stockouts of first-line test kits, controlled for reporting

GRAPH TO GO HERE 

## Total days stocked out by facility

```{r so_days1, echo=FALSE, warning=FALSE}
plot = gen_so_days1(dt, drug_id, drug_name, full_date_range)
plot
``` 

## Map of total facility-days of stockouts

```{r so_map1, echo=FALSE, warning=FALSE}
plot = gen_so_map1(dt, drug_id, drug_name, full_date_range)
plot
```

## Map of mean number of days stocked out

```{r so_map2, echo=FALSE, warning=FALSE}
plot = gen_so_map2(dt, coord_ann, drug_id, drug_name, full_date_range)
plot
```

## Rate of change of stockouts

```{r roc1, echo=FALSE, warning=FALSE}
plot = gen_roc1(dt, drug_id, drug_name, full_date_range)
plot
```

## Stock-out rate of change, by month

```{r monthly_so_roc1, echo=FALSE, warning=FALSE}
plot = gen_monthly_so_roc1(dt, coord_months, drug_id, drug_name, full_date_range)
plot
```

## Districts with more stockouts in 2018 than 2017

```{r roc3, echo=FALSE, warning=FALSE}
plot = gen_roc3(dt, drug_id, drug_name, full_date_range)
plot
```

## Percentage of facility-days stocked out

```{r so_pct1, echo=FALSE, warning=FALSE}
plot = gen_so_pct1(dt, drug_id, drug_name, full_date_range)
plot
```

## Days stocked out by facility level (all)

```{r scatter1, echo=FALSE, warning=FALSE}
plot = gen_scatter1(dt, drug_id, drug_name, full_date_range)
plot
``` 

## Days stocked out by facility level (grouped)

```{r scatter2, echo=FALSE, warning=FALSE}
plot = gen_scatter2(dt, drug_id, drug_name, full_date_range)
plot
```

## Days stocked out by facility level (grouped, by year)

```{r scatter3, echo=FALSE, warning=FALSE}
plot = gen_scatter3(dt, drug_id, drug_name, full_date_range)
plot
```

## Stock-out duration, 2017 (No stockouts - 2 MO)

```{r cat1_2017, echo=FALSE, warning=FALSE}
plot = gen_cat1_2017(dt, coord_ann, drug_id, drug_name)
plot
``` 

## Stock-out duration, 2017 (2-month intervals)

```{r cat3_2017, echo=FALSE, warning=FALSE}
plot = gen_cat3_2017(dt, coord_ann, drug_id, drug_name)
plot
```

## Stock-out duration, 2018 (No stockouts - 2 MO)

```{r cat1_2018, echo=FALSE, warning=FALSE}
plot = gen_cat1_2018(dt, coord_ann, drug_id, drug_name)
plot
```

## Stock-out duration, 2018 (2-month intervals)

```{r cat3_2018, echo=FALSE, warning=FALSE}
plot = gen_cat3_2018(dt, coord_ann, drug_id, drug_name)
plot
```

## Mean drug units per facility, by district

```{r mean_units1, echo=FALSE, warning=FALSE}
plot = gen_mean_units1(dt, coord_ann, drug_id, drug_name, full_date_range)
plot
```


