# ----------------------------------------------
# Caitlin O'Brien- Carelli
# Combine the SIGPRO Testing data sets

# ----------------------------------------------

#-----------------------------------------------
# Install packages 
# ----------------------------------------------
rm(list=ls())
library(lubridate)
library(data.table)
library(openxlsx)
library(ggplot2)
library(Hmisc)
library(stringr)
library(XLConnect)
#---------------------------------------
# Set up directories 
#----------------------------------------

# detect if operating on windows or on the cluster 
j = ifelse(Sys.info()[1]=='Windows', 'J:', '/home/j')

# set working and output directories
dir = paste0(j, '/Project/Evaluation/GF/outcome_measurement/gtm/hiv/')

#----------------------------------------
# load sigpro testing data 

f1 = readRDS(paste0(dir, 'prepped/sigpro_f1_completo 2018.xlsx_prepped.RDS'))
f2 = readRDS(paste0(dir, 'prepped/sigpro_f2_completo 2018.xlsx_prepped.RDS'))
f3 = readRDS(paste0(dir, 'prepped/sigpro_f3_completo 2018.xlsx_prepped.RDS'))
f4 = readRDS(paste0(dir, 'prepped/sigpro_f4_completo 2018.xlsx_prepped.RDS'))
f5 = readRDS(paste0(dir, 'prepped/sigpro_f4_JanNov2018 - PB_TVC.csv_prepped.RDS'))

#----------------------------------------
# Remove values flagged as errors 

# f1 errors
f1 = f1[age!='total']
f1[age=="41913" | age=="43348", age:=NA] # months over 12 already have missing dates

# f2 errors 
f2[year(date)!=2014 & year(date)!=2015 & year(date)!=2016, date:=NA]

# f3 errors; no errors in f4
f3[year(date) < 2016, date:=NA]

# f5 errors 
f5['2019-02-01' < date, date:=NA]

#----------------------------------------
# combine the data sets - f3 and f4
# patient level data

# subset and combine similar data sets
vars = c("set", "sr_code", "department", "muni", "date",  
         "theme", "pop", "subpop", "gender", 
         "result", "informed_of_result")

f3 = f3[, vars, with=FALSE]
f4 = f4[, vars, with=FALSE]
F5 = f5[ ,vars, with=FALSE]

# bind and add variable to fit with f2
f = rbind(f3, f4)
f[ , sr:=NA]





#---------------------------
# combine the data sets - f2 with f3 and f4

# subset and combine the patient level data
vars2 = c("set", "sr_code", "sr", "department", "muni", "date",  
          "pop", "subpop", "gender", 
         "result", "informed_of_result")

# subset and add theme
f2 = f2[ ,vars2, with=FALSE]
f2[ , theme:=NA]

# bind it in
# keep informed of result - only NA if the test was not done 
f = rbind(f, f2)

#---------------------------
# add sr names based on codes and names in other data sets

# werkin on it :( 

#---------------------------
# for the sr level data, add a value for each patient
# add values - patients level so each row is 1

f[ ,value:=1]

# fix sr names with poor formatting
f[ , sr:=trimws(sr)]

#---------------------------
# perform data quality checks on the patient level data 
# 
# # check unique values for erroneous values
# f[ ,unique(sr_code), by=sr]
# f[ ,unique(department)]
# f[ ,unique(muni)]
# 
# # check for outlier dates 
# test = f[ ,.(pts=sum(value)), by=date]
# ggplot(test, aes(x=date, y=pts)) +
#   geom_point() +
#   geom_line()

#-------------------------------------------------------
# sum the final results 

# drop informed of result - early data only has positive or negative
# no information in f1 on informing patients
f = f[ ,.(value=sum(value)), by=.(set, sr, sr_code,
        department, muni, date, theme, pop, subpop,
        gender, result)]

#---------------------------
# aggregate to the sr, muni, department level

# fix the age categories
# drop out 'total' age groups
f1 = f1[age!="total"]

# update the age
f1[!grepl("-", age) & !grepl("<", age) & !grepl("\\+", age), age:=NA]

#---------------------------
# keep only hiv-related data, drop syphilis

f1 = f1[grep("vih", result)]

# format the test results to contain the same variables as the other data
f1[grep("negativo", result), result:="nonreactive"]
f1[grep("positivo", result), result:="reactive"]
f1[grep("presuntivo", result), result:="test not done"]

#---------------------------
# create subpopulations 

# reset variable name
setnames(f1, "category", "subpop")

# finalize shaped long
setnames(f1, "total", "value")

#---------------------------
# drop unecessary variables and create variables for rbind

f1[ ,c("flag", "pregnant", "numeroInforme"):=NULL] # subpop captures pregnancy

# add variables that occur in the patient level data captured in f
f1[ ,department:=NA]
f1[ ,muni:=NA]
f1[ ,theme:=NA]

#---------------------------
# sum over the age categories

byVars = names(f1)[names(f1)!='value' & names(f1)!='age']
f1 = f1[ ,.(value=sum(value)), by=byVars]

#---------------------------
# bind the data together

f = rbind(f, f1)

#--------------------------------------------------------
# save the product

saveRDS(f, paste0(dir, 'prepped/sigpro_october_2018_transfer_prepped.RDS'))

#--------------------------------------------------------



